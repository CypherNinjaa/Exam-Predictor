// ===========================================
// PRISMA SCHEMA - AI EXAM PREDICTOR
// Amity University Patna
// ===========================================
// Structure: College -> Course -> Batch -> Semester -> Subject
// Example: AUP -> BCA -> 2024-2027 -> Sem 1 -> DBMS
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CORE ENTITIES ====================

model College {
  id        String   @id @default(cuid())
  name      String   @unique // "Amity University Patna"
  code      String   @unique // "AUP"
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courses Course[]
}

// Course = Degree Program (BCA, BTech CSE, MBA, etc.)
model Course {
  id          String   @id @default(cuid())
  name        String // "Bachelor of Computer Applications"
  code        String // "BCA"
  duration    Int      @default(3) // Years (3 for BCA, 4 for BTech)
  collegeId   String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  batches Batch[]

  @@unique([collegeId, code])
}

// Batch = A group of students starting in a specific year
// Example: BCA 2024-2027, BTech 2024-2028
model Batch {
  id        String   @id @default(cuid())
  startYear Int // 2024
  endYear   Int // 2027 for 3yr course, 2028 for 4yr
  courseId  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relations
  course    Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  semesters Semester[]

  @@unique([courseId, startYear])
}

// Semester within a batch
// BCA 2024-2027 will have Sem 1-6 (3 years x 2 semesters)
// BTech 2024-2028 will have Sem 1-8 (4 years x 2 semesters)
model Semester {
  id        String   @id @default(cuid())
  number    Int // 1, 2, 3... (1-6 for 3yr, 1-8 for 4yr)
  batchId   String
  createdAt DateTime @default(now())

  // Relations
  batch    Batch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  subjects Subject[]
  exams    Exam[]

  @@unique([batchId, number])
}

// Subject belongs to a specific semester of a batch
// This allows different batches to have different subjects
model Subject {
  id         String   @id @default(cuid())
  code       String // "BCA301"
  name       String // "Database Management Systems"
  credits    Int      @default(3)
  semesterId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  semester Semester   @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  syllabus Syllabus?
  exams    Exam[]

  @@unique([semesterId, code])
}

// ==================== SYLLABUS ====================

model Syllabus {
  id          String   @id @default(cuid())
  subjectId   String   @unique
  version     String   @default("1.0")
  description String?
  pdfUrl      String?
  fileHash    String?  // MD5 hash for duplicate detection
  totalHours  Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subject    Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  modules    Module[]
  books      Book[]
  evaluation EvaluationScheme?
}

model Module {
  id          String   @id @default(cuid())
  number      Int
  name        String
  description String?
  syllabusId  String
  weightage   Float?
  hours       Int?
  createdAt   DateTime @default(now())

  // Relations
  syllabus  Syllabus   @relation(fields: [syllabusId], references: [id], onDelete: Cascade)
  topics    Topic[]
  questions Question[]

  @@unique([syllabusId, number])
}

model Topic {
  id             String    @id @default(cuid())
  name           String
  description    String?
  moduleId       String
  orderIndex     Int       @default(0)
  lastAskedDate  DateTime?
  timesAsked     Int       @default(0)
  freshnessScore Float     @default(0.5)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  module    Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  subTopics SubTopic[]
  questions Question[]
}

model SubTopic {
  id        String   @id @default(cuid())
  name      String
  topicId   String
  createdAt DateTime @default(now())

  // Relations
  topic     Topic      @relation(fields: [topicId], references: [id], onDelete: Cascade)
  questions Question[]
}

// ==================== BOOKS & EVALUATION ====================

enum BookType {
  TEXTBOOK
  REFERENCE
}

model Book {
  id         String   @id @default(cuid())
  title      String
  author     String?
  publisher  String?
  year       Int?
  edition    String?
  bookType   BookType @default(TEXTBOOK)
  syllabusId String
  createdAt  DateTime @default(now())

  // Relations
  syllabus Syllabus @relation(fields: [syllabusId], references: [id], onDelete: Cascade)
}

model EvaluationScheme {
  id              String   @id @default(cuid())
  syllabusId      String   @unique
  midterm1        Float?
  midterm2        Float?
  endterm         Float?
  assignments     Float?
  practicals      Float?
  attendance      Float?
  otherComponents Json?
  createdAt       DateTime @default(now())

  // Relations
  syllabus Syllabus @relation(fields: [syllabusId], references: [id], onDelete: Cascade)
}

// ==================== EXAMS & QUESTIONS ====================

enum ExamType {
  MIDTERM_1
  MIDTERM_2
  END_TERM
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum BloomsTaxonomy {
  REMEMBER
  UNDERSTAND
  APPLY
  ANALYZE
  EVALUATE
  CREATE
}

model Exam {
  id          String    @id @default(cuid())
  examType    ExamType
  subjectId   String
  semesterId  String
  examDate    DateTime?
  totalMarks  Int       @default(60)
  duration    Int       @default(180)
  pdfUrl      String?
  isProcessed Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  subject   Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  semester  Semester   @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  questions Question[]

  @@unique([subjectId, examType, semesterId])
}

model Question {
  id             String         @id @default(cuid())
  questionNumber String
  text           String
  marks          Int
  examId         String
  moduleId       String?
  topicId        String?
  subTopicId     String?
  difficulty     Difficulty     @default(MEDIUM)
  bloomsLevel    BloomsTaxonomy @default(UNDERSTAND)
  keywords       String[]
  vectorId       String?
  imageUrl       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  exam        Exam                 @relation(fields: [examId], references: [id], onDelete: Cascade)
  module      Module?              @relation(fields: [moduleId], references: [id])
  topic       Topic?               @relation(fields: [topicId], references: [id])
  subTopic    SubTopic?            @relation(fields: [subTopicId], references: [id])
  predictions PredictionQuestion[]
}

// ==================== PREDICTIONS ====================

model Prediction {
  id             String   @id @default(cuid())
  targetExamType ExamType
  subjectId      String
  generatedAt    DateTime @default(now())
  confidence     Float
  modelVersion   String   @default("1.0")
  isValidated    Boolean  @default(false)
  accuracyScore  Float?

  // Relations
  questions PredictionQuestion[]
}

model PredictionQuestion {
  id                String   @id @default(cuid())
  predictionId      String
  generatedText     String
  probability       Float
  reasoning         String[]
  suggestedMarks    Int
  targetModule      String?
  targetTopic       String?
  wasAccurate       Boolean?
  matchedQuestionId String?
  createdAt         DateTime @default(now())

  // Relations
  prediction      Prediction @relation(fields: [predictionId], references: [id], onDelete: Cascade)
  matchedQuestion Question?  @relation(fields: [matchedQuestionId], references: [id])
}

// ==================== LECTURE NOTES ====================

model LectureNote {
  id          String   @id @default(cuid())
  subjectCode String
  title       String?
  content     String
  sourceType  String
  sourceUrl   String?
  keywords    Json?
  createdAt   DateTime @default(now())

  @@index([subjectCode])
}

// ==================== PROCESSING LOGS ====================

model ProcessingLog {
  id          String    @id @default(cuid())
  fileName    String
  fileType    String
  status      String
  errorMsg    String?
  processedAt DateTime?
  createdAt   DateTime  @default(now())
}
