// ===========================================
// PRISMA SCHEMA - AI EXAM PREDICTOR
// Amity University Patna
// ===========================================
// Structure: College -> Course -> Batch -> Semester -> Subject
// Example: AUP -> BCA -> 2024-2027 -> Sem 1 -> DBMS
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CORE ENTITIES ====================

model College {
  id        String   @id @default(cuid())
  name      String   @unique // "Amity University Patna"
  code      String   @unique // "AUP"
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  courses Course[]
}

// Course = Degree Program (BCA, BTech CSE, MBA, etc.)
model Course {
  id          String   @id @default(cuid())
  name        String // "Bachelor of Computer Applications"
  code        String // "BCA"
  duration    Int      @default(3) // Years (3 for BCA, 4 for BTech)
  collegeId   String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  college College @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  batches Batch[]

  @@unique([collegeId, code])
}

// Batch = A group of students starting in a specific year
// Example: BCA 2024-2027, BTech 2024-2028
model Batch {
  id        String   @id @default(cuid())
  startYear Int // 2024
  endYear   Int // 2027 for 3yr course, 2028 for 4yr
  courseId  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // Relations
  course    Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  semesters Semester[]

  @@unique([courseId, startYear])
}

// Semester within a batch
// BCA 2024-2027 will have Sem 1-6 (3 years x 2 semesters)
// BTech 2024-2028 will have Sem 1-8 (4 years x 2 semesters)
model Semester {
  id        String   @id @default(cuid())
  number    Int // 1, 2, 3... (1-6 for 3yr, 1-8 for 4yr)
  batchId   String
  createdAt DateTime @default(now())

  // Relations
  batch    Batch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  subjects Subject[]
  exams    Exam[]

  @@unique([batchId, number])
}

// Subject belongs to a specific semester of a batch
// This allows different batches to have different subjects
model Subject {
  id         String   @id @default(cuid())
  code       String // "BCA301"
  name       String // "Database Management Systems"
  credits    Int      @default(3)
  semesterId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  semester Semester   @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  syllabus Syllabus?
  exams    Exam[]
  notes    Note[]     // NEW: Notes for this subject

  @@unique([semesterId, code])
}

// ==================== SYLLABUS ====================

model Syllabus {
  id          String   @id @default(cuid())
  subjectId   String   @unique
  version     String   @default("1.0")
  description String?
  pdfUrl      String?
  fileHash    String?  // MD5 hash for duplicate detection
  totalHours  Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subject    Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  modules    Module[]
  books      Book[]
  evaluation EvaluationScheme?
}

model Module {
  id          String   @id @default(cuid())
  number      Int
  name        String
  description String?
  syllabusId  String
  weightage   Float?
  hours       Int?
  createdAt   DateTime @default(now())

  // Relations
  syllabus  Syllabus   @relation(fields: [syllabusId], references: [id], onDelete: Cascade)
  topics    Topic[]
  questions Question[]

  @@unique([syllabusId, number])
}

model Topic {
  id             String    @id @default(cuid())
  name           String
  description    String?
  moduleId       String
  orderIndex     Int       @default(0)
  lastAskedDate  DateTime?
  timesAsked     Int       @default(0)
  freshnessScore Float     @default(0.5)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  module    Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  subTopics SubTopic[]
  questions Question[]
}

model SubTopic {
  id        String   @id @default(cuid())
  name      String
  topicId   String
  createdAt DateTime @default(now())

  // Relations
  topic     Topic      @relation(fields: [topicId], references: [id], onDelete: Cascade)
  questions Question[]
}

// ==================== BOOKS & EVALUATION ====================

enum BookType {
  TEXTBOOK
  REFERENCE
}

model Book {
  id         String   @id @default(cuid())
  title      String
  author     String?
  publisher  String?
  year       Int?
  edition    String?
  bookType   BookType @default(TEXTBOOK)
  syllabusId String
  createdAt  DateTime @default(now())

  // Relations
  syllabus Syllabus @relation(fields: [syllabusId], references: [id], onDelete: Cascade)
}

model EvaluationScheme {
  id              String   @id @default(cuid())
  syllabusId      String   @unique
  midterm1        Float?
  midterm2        Float?
  endterm         Float?
  assignments     Float?
  practicals      Float?
  attendance      Float?
  otherComponents Json?
  createdAt       DateTime @default(now())

  // Relations
  syllabus Syllabus @relation(fields: [syllabusId], references: [id], onDelete: Cascade)
}

// ==================== EXAMS & QUESTIONS ====================

enum ExamType {
  MIDTERM_1
  MIDTERM_2
  END_TERM
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum QuestionType {
  MCQ
  SHORT
  LONG
  DESCRIPTIVE
}

enum BloomsTaxonomy {
  REMEMBER
  UNDERSTAND
  APPLY
  ANALYZE
  EVALUATE
  CREATE
}

model Exam {
  id           String    @id @default(cuid())
  examType     ExamType
  subjectId    String
  semesterId   String
  examDate     DateTime?
  academicYear String?   // e.g., "2024-2025"
  totalMarks   Int       @default(60)
  duration     Int       @default(180) // in minutes
  pdfUrl       String?
  fileHash     String?   // MD5 hash for duplicate detection
  isProcessed  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  subject   Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  semester  Semester   @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  questions Question[]

  @@unique([subjectId, examType, semesterId, academicYear])
}

model Question {
  id               String          @id @default(cuid())
  questionNumber   String
  text             String
  marks            Int
  examId           String
  moduleId         String?
  topicId          String?
  subTopicId       String?
  section          String?         // e.g., "A", "B", "C"
  questionType     QuestionType    @default(SHORT)
  difficulty       Difficulty      @default(MEDIUM)
  bloomsLevel      BloomsTaxonomy  @default(UNDERSTAND)
  keywords         String[]
  options          String[]        // For MCQ questions
  hasAlternative   Boolean         @default(false) // Is this an "OR" question?
  alternativeToId  String?         // Points to the question this is an alternative to
  vectorId         String?
  imageUrl         String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  exam          Exam                 @relation(fields: [examId], references: [id], onDelete: Cascade)
  module        Module?              @relation(fields: [moduleId], references: [id])
  topic         Topic?               @relation(fields: [topicId], references: [id])
  subTopic      SubTopic?            @relation(fields: [subTopicId], references: [id])
  alternativeTo Question?            @relation("QuestionAlternatives", fields: [alternativeToId], references: [id])
  alternatives  Question[]           @relation("QuestionAlternatives")
  predictions   PredictionQuestion[]
}

// ==================== PREDICTIONS ====================

model Prediction {
  id             String   @id @default(cuid())
  targetExamType ExamType
  subjectId      String
  generatedAt    DateTime @default(now())
  confidence     Float
  modelVersion   String   @default("1.0")
  isValidated    Boolean  @default(false)
  accuracyScore  Float?

  // Relations
  questions PredictionQuestion[]
}

model PredictionQuestion {
  id                String   @id @default(cuid())
  predictionId      String
  generatedText     String
  probability       Float
  reasoning         String[]
  suggestedMarks    Int
  targetModule      String?
  targetTopic       String?
  wasAccurate       Boolean?
  matchedQuestionId String?
  createdAt         DateTime @default(now())

  // Relations
  prediction      Prediction @relation(fields: [predictionId], references: [id], onDelete: Cascade)
  matchedQuestion Question?  @relation(fields: [matchedQuestionId], references: [id])
}

// ==================== LECTURE NOTES ====================

model Note {
  id            String   @id @default(cuid())
  title         String
  description   String?
  
  // File info (original file stored in public/uploads/notes/)
  fileName      String
  fileUrl       String   // Relative path: /uploads/notes/xyz.pdf
  fileType      String   // pdf, docx, pptx, jpg, png, etc.
  fileSize      Int      // in bytes
  
  // Relations
  subjectId     String
  subject       Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // AI-extracted content
  extractedText String?  @db.Text // Full text extracted by AI
  keyTopics     String[] // Main topics covered
  moduleNumbers Int[]    // Which modules it covers [1, 2, 3]
  
  // Public access
  isPublic      Boolean  @default(true)
  downloadCount Int      @default(0)
  
  // Metadata
  uploadedBy    String   // Clerk user ID (admin who uploaded)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([subjectId])
  @@index([isPublic])
}

model LectureNote {
  id          String   @id @default(cuid())
  subjectCode String
  title       String?
  content     String
  sourceType  String
  sourceUrl   String?
  keywords    Json?
  createdAt   DateTime @default(now())

  @@index([subjectCode])
}

// ==================== PROCESSING LOGS ====================

model ProcessingLog {
  id          String    @id @default(cuid())
  fileName    String
  fileType    String
  status      String
  errorMsg    String?
  processedAt DateTime?
  createdAt   DateTime  @default(now())
}

// ==================== USER MANAGEMENT ====================

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

model User {
  id              String         @id // Clerk user ID
  email           String         @unique
  name            String?
  role            UserRole       @default(USER)
  isBanned        Boolean        @default(false)
  bannedReason    String?
  bannedAt        DateTime?
  lastActiveAt    DateTime       @default(now())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  activityLogs    ActivityLog[]
  predictionLogs  PredictionLog[]
  downloadLogs    DownloadLog[]
  conversations   ChatConversation[]
  memories        UserMemory[]
  
  @@index([role])
  @@index([isBanned])
  @@index([lastActiveAt])
}

// ==================== AI CHAT ====================

model ChatConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String   // First message or custom title
  modelUsed String   @default("gemini-3.0") // "gemini-3.0" or "advanced"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]
  
  @@index([userId])
  @@index([updatedAt])
}

// ==================== AI MEMORY SYSTEM ====================

enum MemoryCategory {
  ACADEMIC      // Subjects, exams, study topics
  PERSONAL      // Name, batch, course details
  PREFERENCES   // Study preferences, communication style
  GOALS         // Academic goals, target scores
  STUDY_PATTERN // Study habits, best times, methods
  OTHER         // Miscellaneous
}

enum MemoryImportance {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model UserMemory {
  id          String           @id @default(cuid())
  userId      String
  
  // Memory content
  title       String           // Short title (e.g., "Preferred Study Time")
  content     String           @db.Text // Actual memory (e.g., "Prefers studying late night 10 PM - 2 AM")
  category    MemoryCategory   @default(OTHER)
  importance  MemoryImportance @default(MEDIUM)
  
  // Metadata
  keywords    String[]         // For search: ["study", "time", "night"]
  relatedTo   String?          // Related entity ID (subjectId, examId, etc.)
  
  // Auto-detection
  confidence  Float            @default(1.0) // AI confidence (0-1)
  source      String           @default("user") // "user", "ai_detected", "admin"
  sourceConversationId String? // Which chat conversation this came from
  
  // Usage tracking
  timesUsed   Int              @default(0) // How many times AI used this memory
  lastUsedAt  DateTime?        // When was it last used
  
  // Privacy & Control
  isActive    Boolean          @default(true) // User can disable without deleting
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([category])
  @@index([importance])
  @@index([isActive])
  @@index([keywords])
  @@index([lastUsedAt])
}

model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  role           String           // "user" or "model"
  text           String           @db.Text
  createdAt      DateTime         @default(now())
  
  // Relations
  conversation ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([createdAt])
}

enum ActivityType {
  LOGIN
  LOGOUT
  PREDICTION_GENERATED
  NOTE_DOWNLOADED
  NOTE_UPLOADED
  QUESTION_UPLOADED
  SYLLABUS_UPLOADED
  USER_PROMOTED
  USER_BANNED
  USER_UNBANNED
  CHAT_CREATED
  CHAT_MESSAGE_SENT
}

model ActivityLog {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  activityType ActivityType
  description String?
  metadata    Json?        // Additional data like subjectId, fileId, etc.
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime     @default(now())
  
  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
}

// ==================== ANALYTICS TRACKING ====================

model PredictionLog {
  id              String   @id @default(cuid())
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  subjectId       String
  examType        ExamType
  modelUsed       String   // "gemini-2.5-pro", "gemini-3-pro-preview", etc.
  confidenceScore Float
  questionsCount  Int
  processingTime  Int      // in seconds
  createdAt       DateTime @default(now())
  
  @@index([subjectId])
  @@index([examType])
  @@index([createdAt])
}

model DownloadLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  noteId    String
  createdAt DateTime @default(now())
  
  @@index([noteId])
  @@index([createdAt])
}
